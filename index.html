<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowOptimize - Cash Flow Minimizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #FFFFFF;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #4a0e4e 0%, #1a0520 50%, #000000 100%);
            border-bottom: 1px solid #FF00FF;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .hamburger {
            font-size: 24px;
            cursor: pointer;
            color: #FFFFFF;
            transition: color 0.3s;
        }

        .hamburger:hover {
            color: #FF00FF;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 1px;
            color: #FFFFFF;
        }

        .currency-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .currency-selector label {
            font-size: 14px;
            font-weight: 600;
        }

        .currency-selector select {
            background: rgba(255, 0, 255, 0.1);
            border: 1px solid #FF00FF;
            color: #FFFFFF;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 60px;
            left: 0;
            width: 280px;
            height: calc(100vh - 60px);
            background: linear-gradient(180deg, #2d0a3d 0%, #1a0520 50%, #000000 100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            z-index: 999;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .nav-links {
            padding: 40px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 18px 25px;
            color: #FFFFFF;
            text-decoration: none;
            font-size: 15px;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(255, 0, 255, 0.1);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #FF00FF;
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 18px;
        }

        .history-section {
            padding: 20px 25px;
            border-top: 1px solid rgba(255, 0, 255, 0.3);
            margin-top: 20px;
        }

        .history-title {
            font-size: 14px;
            font-weight: 700;
            color: #FF00FF;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 10px 0;
            font-size: 13px;
            color: #CCCCCC;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-footer {
            padding: 30px 25px;
            border-top: 1px solid rgba(255, 0, 255, 0.3);
            margin-top: auto;
        }

        .footer-line {
            font-size: 13px;
            color: #CCCCCC;
            margin-bottom: 8px;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            margin-top: 60px;
            padding: 40px;
            transition: margin-left 0.3s ease;
            min-height: calc(100vh - 60px);
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Input Container - Centered Gemini Style */
        .input-container {
            max-width: 700px;
            margin: 80px auto;
            background: linear-gradient(135deg, rgba(74, 14, 78, 0.3) 0%, rgba(26, 5, 32, 0.5) 100%);
            border: 1px solid rgba(255, 0, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
        }

        .input-container h2 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 30px;
            text-align: center;
            color: #FFFFFF;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 0, 255, 0.3);
            border-radius: 8px;
            color: #FFFFFF;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #FF00FF;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: #FF00FF;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary:hover {
            background: #CC00CC;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 0, 255, 0.4);
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: rgba(255, 0, 255, 0.2);
            color: #FFFFFF;
            border: 1px solid #FF00FF;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: rgba(255, 0, 255, 0.3);
        }

        /* Transaction List */
        .transaction-list {
            max-width: 900px;
            margin: 30px auto;
        }

        .transaction-item {
            background: rgba(74, 14, 78, 0.2);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-info {
            font-size: 14px;
        }

        .btn-remove {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #FF0000;
            color: #FFFFFF;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Results Section */
        .results-section {
            max-width: 1000px;
            margin: 50px auto;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(74, 14, 78, 0.4) 0%, rgba(26, 5, 32, 0.6) 100%);
            border: 1px solid rgba(255, 0, 255, 0.4);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 800;
            color: #FF00FF;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 14px;
            color: #CCCCCC;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .animation-container {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 0, 255, 0.3);
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 40px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settlements-table {
            background: rgba(74, 14, 78, 0.2);
            border: 1px solid rgba(255, 0, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .settlements-table h3 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #FF00FF;
        }

        .settlement-row {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settlement-info {
            font-size: 15px;
        }

        .fx-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .fx-low {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00FF00;
            color: #00FF00;
        }

        .fx-medium {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid #FFFF00;
            color: #FFFF00;
        }

        .fx-high {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #FF0000;
            color: #FF0000;
        }

        /* SVG Animation */
        .flow-animation {
            width: 100%;
            height: 250px;
        }

        .arrow-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawArrow 2s ease forwards;
        }

        @keyframes drawArrow {
            to {
                stroke-dashoffset: 0;
            }
        }

        .arrow-initial {
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 1;
        }

        .arrow-optimized {
            stroke: #FF00FF;
            stroke-width: 3;
            animation-delay: 1s;
        }

        /* Bank Mode Specific */
        .bank-fields {
            display: none;
        }

        .bank-fields.active {
            display: block;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 998;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px);
                z-index: 999;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .input-container {
                margin: 40px auto;
                padding: 25px;
            }

            .metrics-container {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 0 15px;
            }

            .logo {
                font-size: 20px;
            }

            .currency-selector label {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .input-container {
                padding: 20px;
            }

            .input-container h2 {
                font-size: 22px;
            }

            .transaction-item {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .settlement-row {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="hamburger" id="hamburger">
                <i class="fas fa-bars"></i>
            </div>
            <div class="logo">FlowOptimize</div>
        </div>
        <div class="currency-selector">
            <label for="globalCurrency">Currency:</label>
            <select id="globalCurrency">
                <option value="USD">USD ($)</option>
                <option value="INR">INR (₹)</option>
                <option value="GBP">GBP (£)</option>
            </select>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="nav-links">
            <a class="nav-link active" data-mode="people">
                <i class="fas fa-users"></i>
                <span>Within People Settlements</span>
            </a>
            <a class="nav-link" data-mode="bank">
                <i class="fas fa-university"></i>
                <span>Within Bank Settlements (Advanced)</span>
            </a>
        </div>

        <div class="history-section">
            <div class="history-title">Past Resolved Payments</div>
            <ul class="history-list" id="historyList">
                <!-- History items will be added here -->
            </ul>
        </div>

        <div class="sidebar-footer">
            <div class="footer-line"><strong>Project Name:</strong> FlowOptimize</div>
            <div class="footer-line"><strong>Created by:</strong> Samitesh Panda</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Transaction Input Container -->
        <div class="input-container">
            <h2 id="modeTitle">Add Transactions</h2>

            <!-- People Mode -->
            <div id="peopleMode">
                <div class="form-group">
                    <label for="payer">Payer</label>
                    <input type="text" id="payer" placeholder="Enter payer name">
                </div>
                <div class="form-group">
                    <label for="receiver">Receiver</label>
                    <input type="text" id="receiver" placeholder="Enter receiver name">
                </div>
                <div class="form-group">
                    <label for="amount">Amount</label>
                    <input type="number" id="amount" placeholder="Enter amount" min="0" step="0.01">
                </div>
                <button class="btn-primary" onclick="addTransaction()">
                    <i class="fas fa-plus"></i> Add Transaction
                </button>
            </div>

            <!-- Bank Mode -->
            <div id="bankMode" class="bank-fields">
                <div class="form-row">
                    <div class="form-group">
                        <label for="payerCountry">Payer Country</label>
                        <select id="payerCountry" onchange="updateBankOptions('payer')">
                            <option value="">Select Country</option>
                            <option value="India">India</option>
                            <option value="USA">USA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payerBank">Payer Bank</label>
                        <select id="payerBank" onchange="updateBranchOptions('payer')">
                            <option value="">Select Bank</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payerBranch">Payer Branch</label>
                    <select id="payerBranch">
                        <option value="">Select Branch</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="receiverCountry">Receiver Country</label>
                        <select id="receiverCountry" onchange="updateBankOptions('receiver')">
                            <option value="">Select Country</option>
                            <option value="India">India</option>
                            <option value="USA">USA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="receiverBank">Receiver Bank</label>
                        <select id="receiverBank" onchange="updateBranchOptions('receiver')">
                            <option value="">Select Bank</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="receiverBranch">Receiver Branch</label>
                    <select id="receiverBranch">
                        <option value="">Select Branch</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bankAmount">Amount</label>
                    <input type="number" id="bankAmount" placeholder="Enter amount" min="0" step="0.01">
                </div>
                <button class="btn-primary" onclick="addBankTransaction()">
                    <i class="fas fa-plus"></i> Add Bank Transaction
                </button>
            </div>
        </div>

        <!-- Transaction List -->
        <div class="transaction-list" id="transactionList"></div>

        <!-- Optimize Button -->
        <div class="input-container" id="optimizeContainer" style="display: none;">
            <button class="btn-primary" onclick="optimizeSettlements()">
                <i class="fas fa-magic"></i> Optimize Settlements
            </button>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="metrics-container">
                <div class="metric-card">
                    <div class="metric-value" id="originalCount">0</div>
                    <div class="metric-label">Original Transactions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="optimizedCount">0</div>
                    <div class="metric-label">Optimized Transactions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="reductionPercent">0%</div>
                    <div class="metric-label">Reduction</div>
                </div>
            </div>

            <div class="animation-container">
                <svg class="flow-animation" id="flowAnimation">
                    <!-- Animation will be generated here -->
                </svg>
            </div>

            <div class="settlements-table">
                <h3>Optimized Settlements</h3>
                <div id="settlementsList"></div>
            </div>

            <button class="btn-primary" onclick="downloadCSV()">
                <i class="fas fa-download"></i> Download Settlement Sheet (CSV)
            </button>
        </div>
    </div>

    <script>
        // Global Variables
        let transactions = [];
        let currentMode = 'people';
        let optimizedSettlements = [];

        // Bank Data Structure
        const bankData = {
            India: {
                banks: ['SBI', 'HDFC', 'ICICI'],
                branches: ['Bhubaneswar', 'Sambalpur', 'Cuttack']
            },
            USA: {
                banks: ['Bank of America', 'Chase', 'Wells Fargo'],
                branches: ['New York', 'Los Angeles', 'Chicago', 'Houston']
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.getElementById('sidebarOverlay');

            // Hamburger menu toggle
            document.getElementById('hamburger').addEventListener('click', function() {
                // Check if mobile view
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    sidebar.classList.toggle('mobile-open');
                    overlay.classList.toggle('active');
                } else {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                }
            });

            // Close sidebar when clicking overlay (mobile)
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                const isMobile = window.innerWidth <= 768;
                
                if (!isMobile) {
                    // Desktop: remove mobile classes
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                } else {
                    // Mobile: ensure sidebar is hidden and main content is full width
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                }
            });

            // Navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentMode = this.dataset.mode;
                    switchMode(currentMode);

                    // Close sidebar on mobile after selection
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('active');
                    }
                });
            });
        });

        // Switch between People and Bank modes
        function switchMode(mode) {
            const peopleMode = document.getElementById('peopleMode');
            const bankMode = document.getElementById('bankMode');
            const modeTitle = document.getElementById('modeTitle');

            if (mode === 'people') {
                peopleMode.style.display = 'block';
                bankMode.classList.remove('active');
                modeTitle.textContent = 'Add Transactions';
            } else {
                peopleMode.style.display = 'none';
                bankMode.classList.add('active');
                modeTitle.textContent = 'Add Bank Transactions';
            }

            // Clear existing transactions when switching modes
            transactions = [];
            updateTransactionList();
        }

        // Update Bank Options based on Country
        function updateBankOptions(type) {
            const country = document.getElementById(`${type}Country`).value;
            const bankSelect = document.getElementById(`${type}Bank`);
            const branchSelect = document.getElementById(`${type}Branch`);

            bankSelect.innerHTML = '<option value="">Select Bank</option>';
            branchSelect.innerHTML = '<option value="">Select Branch</option>';

            if (country && bankData[country]) {
                bankData[country].banks.forEach(bank => {
                    const option = document.createElement('option');
                    option.value = bank;
                    option.textContent = bank;
                    bankSelect.appendChild(option);
                });
            }
        }

        // Update Branch Options based on Bank
        function updateBranchOptions(type) {
            const country = document.getElementById(`${type}Country`).value;
            const branchSelect = document.getElementById(`${type}Branch`);

            branchSelect.innerHTML = '<option value="">Select Branch</option>';

            if (country && bankData[country]) {
                bankData[country].branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchSelect.appendChild(option);
                });
            }
        }

        // Add Transaction (People Mode)
        function addTransaction() {
            const payer = document.getElementById('payer').value.trim();
            const receiver = document.getElementById('receiver').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);

            if (!payer || !receiver || !amount || amount <= 0) {
                alert('Please fill all fields with valid values');
                return;
            }

            if (payer === receiver) {
                alert('Payer and Receiver cannot be the same');
                return;
            }

            transactions.push({
                payer: payer,
                receiver: receiver,
                amount: amount,
                type: 'people'
            });

            // Clear inputs
            document.getElementById('payer').value = '';
            document.getElementById('receiver').value = '';
            document.getElementById('amount').value = '';

            updateTransactionList();
        }

        // Add Bank Transaction
        function addBankTransaction() {
            const payerCountry = document.getElementById('payerCountry').value;
            const payerBank = document.getElementById('payerBank').value;
            const payerBranch = document.getElementById('payerBranch').value;
            const receiverCountry = document.getElementById('receiverCountry').value;
            const receiverBank = document.getElementById('receiverBank').value;
            const receiverBranch = document.getElementById('receiverBranch').value;
            const amount = parseFloat(document.getElementById('bankAmount').value);

            if (!payerCountry || !payerBank || !payerBranch || !receiverCountry || !receiverBank || !receiverBranch || !amount || amount <= 0) {
                alert('Please fill all fields with valid values');
                return;
            }

            const payer = `${payerBank} - ${payerBranch}`;
            const receiver = `${receiverBank} - ${receiverBranch}`;

            if (payer === receiver) {
                alert('Payer and Receiver cannot be the same');
                return;
            }

            transactions.push({
                payer: payer,
                receiver: receiver,
                amount: amount,
                type: 'bank',
                payerCountry: payerCountry,
                receiverCountry: receiverCountry
            });

            // Clear inputs
            document.getElementById('payerCountry').value = '';
            document.getElementById('payerBank').innerHTML = '<option value="">Select Bank</option>';
            document.getElementById('payerBranch').innerHTML = '<option value="">Select Branch</option>';
            document.getElementById('receiverCountry').value = '';
            document.getElementById('receiverBank').innerHTML = '<option value="">Select Bank</option>';
            document.getElementById('receiverBranch').innerHTML = '<option value="">Select Branch</option>';
            document.getElementById('bankAmount').value = '';

            updateTransactionList();
        }

        // Update Transaction List Display
        function updateTransactionList() {
            const listContainer = document.getElementById('transactionList');
            const optimizeContainer = document.getElementById('optimizeContainer');
            const resultsSection = document.getElementById('resultsSection');

            if (transactions.length === 0) {
                listContainer.innerHTML = '';
                optimizeContainer.style.display = 'none';
                resultsSection.classList.remove('active');
                return;
            }

            const currency = getCurrencySymbol();
            listContainer.innerHTML = transactions.map((t, index) => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <strong>${t.payer}</strong> → <strong>${t.receiver}</strong>: ${currency}${t.amount.toFixed(2)}
                    </div>
                    <button class="btn-remove" onclick="removeTransaction(${index})">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `).join('');

            optimizeContainer.style.display = 'block';
            resultsSection.classList.remove('active');
        }

        // Remove Transaction
        function removeTransaction(index) {
            transactions.splice(index, 1);
            updateTransactionList();
        }

        // Get Currency Symbol
        function getCurrencySymbol() {
            const currency = document.getElementById('globalCurrency').value;
            const symbols = { USD: '$', INR: '₹', GBP: '£' };
            return symbols[currency] || '$';
        }

        // GREEDY CASH FLOW MINIMIZATION ALGORITHM
        function optimizeSettlements() {
            if (transactions.length === 0) {
                alert('Please add transactions first');
                return;
            }

            // Step 1: Create a balance map for all entities
            // Balance Map tracks net balance: positive = creditor, negative = debtor
            const balanceMap = {};

            transactions.forEach(t => {
                // Initialize entities if not present
                if (!balanceMap[t.payer]) balanceMap[t.payer] = 0;
                if (!balanceMap[t.receiver]) balanceMap[t.receiver] = 0;

                // Update balances: payer gives (negative), receiver gets (positive)
                balanceMap[t.payer] -= t.amount;
                balanceMap[t.receiver] += t.amount;
            });

            // Step 2: Convert balance map to array for easier processing
            const balances = Object.keys(balanceMap).map(entity => ({
                entity: entity,
                balance: balanceMap[entity]
            }));

            // Step 3: Initialize optimized settlements array
            optimizedSettlements = [];

            // Step 4: Greedy algorithm - Match max creditor with max debtor
            // Continue until all balances are zero (settled)
            while (true) {
                // Find maximum creditor (largest positive balance)
                let maxCreditor = null;
                let maxCredit = 0;

                for (let i = 0; i < balances.length; i++) {
                    if (balances[i].balance > maxCredit) {
                        maxCredit = balances[i].balance;
                        maxCreditor = i;
                    }
                }

                // Find maximum debtor (largest negative balance in absolute terms)
                let maxDebtor = null;
                let maxDebt = 0;

                for (let i = 0; i < balances.length; i++) {
                    if (Math.abs(balances[i].balance) > maxDebt && balances[i].balance < 0) {
                        maxDebt = Math.abs(balances[i].balance);
                        maxDebtor = i;
                    }
                }

                // If no creditor or debtor found, all balances are settled
                if (maxCreditor === null || maxDebtor === null) {
                    break;
                }

                // Step 5: Calculate transfer amount (minimum of credit and debt)
                const transferAmount = Math.min(maxCredit, maxDebt);

                // Step 6: Create optimized settlement record
                const settlement = {
                    debtor: balances[maxDebtor].entity,
                    creditor: balances[maxCreditor].entity,
                    amount: transferAmount
                };

                // Determine if cross-border and calculate FX risk
                const debtorTransaction = transactions.find(t => 
                    t.payer === settlement.debtor || t.receiver === settlement.debtor
                );
                const creditorTransaction = transactions.find(t => 
                    t.payer === settlement.creditor || t.receiver === settlement.creditor
                );

                if (debtorTransaction && creditorTransaction && 
                    debtorTransaction.payerCountry && creditorTransaction.payerCountry) {
                    settlement.transferType = debtorTransaction.payerCountry !== creditorTransaction.payerCountry ? 
                        'Cross-Border' : 'Domestic';
                    
                    // Simulate FX Risk based on transfer type and amount
                    if (settlement.transferType === 'Cross-Border') {
                        if (transferAmount > 10000) settlement.fxRisk = 'High';
                        else if (transferAmount > 5000) settlement.fxRisk = 'Medium';
                        else settlement.fxRisk = 'Low';
                    } else {
                        settlement.fxRisk = 'Low';
                    }
                } else {
                    settlement.transferType = 'Standard';
                    settlement.fxRisk = 'Low';
                }

                optimizedSettlements.push(settlement);

                // Step 7: Update balances - reduce both by transfer amount
                balances[maxCreditor].balance -= transferAmount;
                balances[maxDebtor].balance += transferAmount;
            }

            // Display results
            displayResults();
            
            // Add to history
            addToHistory();
        }

        // Display Optimization Results
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const originalCount = transactions.length;
            const optimizedCount = optimizedSettlements.length;
            const reduction = ((originalCount - optimizedCount) / originalCount * 100).toFixed(1);

            // Update metrics
            document.getElementById('originalCount').textContent = originalCount;
            document.getElementById('optimizedCount').textContent = optimizedCount;
            document.getElementById('reductionPercent').textContent = `${reduction}%`;

            // Generate flow animation
            generateFlowAnimation(originalCount, optimizedCount);

            // Display settlements
            displaySettlements();

            // Show results section
            resultsSection.classList.add('active');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Generate Flow Animation
        function generateFlowAnimation(original, optimized) {
            const svg = document.getElementById('flowAnimation');
            svg.innerHTML = '';

            const width = svg.clientWidth || 800;
            const height = 250;

            // Initial tangled arrows (left side)
            const initialY = height / 2;
            for (let i = 0; i < Math.min(original, 8); i++) {
                const startY = (i * 25) + 20;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M 50 ${startY} Q ${width * 0.3} ${initialY + (i % 2 ? 20 : -20)} ${width * 0.4} ${initialY}`;
                path.setAttribute('d', d);
                path.setAttribute('class', 'arrow-path arrow-initial');
                path.setAttribute('fill', 'none');
                svg.appendChild(path);
            }

            // Optimized streamlined arrows (right side)
            for (let i = 0; i < Math.min(optimized, 5); i++) {
                const startY = initialY - (optimized * 10) + (i * 30);
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${width * 0.5} ${startY} L ${width - 50} ${startY}`;
                path.setAttribute('d', d);
                path.setAttribute('class', 'arrow-path arrow-optimized');
                path.setAttribute('fill', 'none');
                svg.appendChild(path);

                // Arrow head
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                marker.setAttribute('points', `${width - 50},${startY} ${width - 60},${startY - 5} ${width - 60},${startY + 5}`);
                marker.setAttribute('fill', '#FF00FF');
                marker.setAttribute('class', 'arrow-path arrow-optimized');
                svg.appendChild(marker);
            }

            // Labels
            const labelInitial = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            labelInitial.setAttribute('x', width * 0.2);
            labelInitial.setAttribute('y', height - 20);
            labelInitial.setAttribute('fill', 'rgba(255, 255, 255, 0.6)');
            labelInitial.setAttribute('font-size', '14');
            labelInitial.setAttribute('text-anchor', 'middle');
            labelInitial.textContent = 'Initial (Complex)';
            svg.appendChild(labelInitial);

            const labelOptimized = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            labelOptimized.setAttribute('x', width * 0.75);
            labelOptimized.setAttribute('y', height - 20);
            labelOptimized.setAttribute('fill', '#FF00FF');
            labelOptimized.setAttribute('font-size', '14');
            labelOptimized.setAttribute('text-anchor', 'middle');
            labelOptimized.textContent = 'Optimized (Streamlined)';
            svg.appendChild(labelOptimized);
        }

        // Display Settlements
        function displaySettlements() {
            const container = document.getElementById('settlementsList');
            const currency = getCurrencySymbol();

            container.innerHTML = optimizedSettlements.map(s => {
                const fxClass = s.fxRisk === 'High' ? 'fx-high' : 
                               s.fxRisk === 'Medium' ? 'fx-medium' : 'fx-low';
                
                return `
                    <div class="settlement-row">
                        <div class="settlement-info">
                            <strong>${s.debtor}</strong> pays <strong>${s.creditor}</strong>: 
                            ${currency}${s.amount.toFixed(2)}
                            ${s.transferType !== 'Standard' ? `<em> (${s.transferType})</em>` : ''}
                        </div>
                        <span class="fx-badge ${fxClass}">FX Risk: ${s.fxRisk}</span>
                    </div>
                `;
            }).join('');
        }

        // Add to History
        function addToHistory() {
            const historyList = document.getElementById('historyList');
            const now = new Date();
            const timestamp = now.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const historyItem = document.createElement('li');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <i class="fas fa-check-circle" style="color: #FF00FF; margin-right: 8px;"></i>
                Settlement ${historyList.children.length + 1} - ${timestamp}
            `;

            historyList.insertBefore(historyItem, historyList.firstChild);
        }

        // Download CSV
        function downloadCSV() {
            const currency = document.getElementById('globalCurrency').value;
            
            // CSV Header
            let csv = 'Debtor,Creditor,Amount,Currency,Transfer Type,FX Risk\n';

            // CSV Rows
            optimizedSettlements.forEach(s => {
                csv += `"${s.debtor}","${s.creditor}",${s.amount.toFixed(2)},${currency},${s.transferType},${s.fxRisk}\n`;
            });

            // Create blob and download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FlowOptimize_Settlement_${new Date().getTime()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Update currency display when changed
        document.getElementById('globalCurrency').addEventListener('change', function() {
            if (transactions.length > 0) {
                updateTransactionList();
            }
            if (optimizedSettlements.length > 0) {
                displaySettlements();
            }
        });
    </script>
</body>
</html>